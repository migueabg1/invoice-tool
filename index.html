<!DOCTYPE html>
<html>
<head>
    <title>üì∑ Screenshot to Stripe Invoice</title>
    <style>
        body { 
            font-family: Arial; 
            max-width: 600px; 
            margin: 50px auto; 
            background: #f0f4f8;
            padding: 20px;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #4299e1;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #3182ce;
        }
        input[type="file"] { 
            margin: 20px 0; 
            padding: 10px;
            width: 100%;
        }
        input[type="password"] {
            width: 100%; 
            margin: 5px 0; 
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        button { 
            background: #4299e1; 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: background-color 0.3s;
        }
        button:hover { 
            background: #3182ce; 
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f7fafc; 
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .success {
            background: #f0fff4;
            border-left-color: #38a169;
        }
        .error {
            background: #fed7d7;
            border-left-color: #e53e3e;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .api-keys {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .help-text {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Booking Screenshot ‚Üí üí≥ Stripe Invoice</h1>
        <p>Upload your Booking.com screenshot and automatically create a Stripe invoice!</p>
        
        <div class="upload-area">
            <p>üéØ Drop your Booking.com screenshot here or click to browse</p>
            <input type="file" id="screenshot" accept="image/*">
            <div class="help-text">Supported formats: JPG, PNG, WebP</div>
        </div>
        
        <div class="api-keys">
            <h3>üîë API Keys</h3>
            <div>
                <input type="password" id="stripeKey" placeholder="Stripe Secret Key (sk_test_... or sk_live_...)">
                <div class="help-text">Get from: stripe.com/dashboard/apikeys</div>
            </div>
            <div>
                <input type="password" id="claudeKey" placeholder="Claude API Key">
                <div class="help-text">Get from: console.anthropic.com ‚Üí API Keys</div>
            </div>
        </div>
        
        <button id="processBtn" onclick="processInvoice()">üöÄ Create Stripe Invoice</button>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        async function processInvoice() {
            const screenshot = document.getElementById('screenshot').files[0];
            const stripeKey = document.getElementById('stripeKey').value;
            const claudeKey = document.getElementById('claudeKey').value;
            const resultDiv = document.getElementById('result');
            const processBtn = document.getElementById('processBtn');
            
            // Validation
            if (!screenshot) {
                alert('Please upload a screenshot first!');
                return;
            }
            if (!stripeKey) {
                alert('Please enter your Stripe API key!');
                return;
            }
            if (!claudeKey) {
                alert('Please enter your Claude API key!');
                return;
            }
            
            // Start processing
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading"></span> Processing...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = 'ü§ñ Analyzing screenshot with Claude AI...';
            
            try {
                // Step 1: Convert screenshot to base64
                const base64Image = await convertToBase64(screenshot);
                
                // Step 2: Send to Claude for processing
                resultDiv.innerHTML = 'üß† Extracting booking data...';
                const extractedData = await processWithClaude(base64Image, claudeKey);
                
                resultDiv.innerHTML = 'üí≥ Creating Stripe invoice...';
                
                // Step 3: Create Stripe invoice
                const invoiceUrl = await createStripeInvoice(extractedData, stripeKey);
                
                // Success!
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h3>‚úÖ Invoice Created Successfully!</h3>
                    <p><strong>Customer:</strong> ${extractedData.customer_name}</p>
                    <p><strong>Email:</strong> ${extractedData.customer_email}</p>
                    <p><strong>Amount:</strong> ${extractedData.amount} ${extractedData.currency}</p>
                    <p><strong>Booking Reference:</strong> #${extractedData.booking_reference}</p>
                    <p><strong>Property:</strong> ${extractedData.property_name}</p>
                    <p><strong>Dates:</strong> ${extractedData.checkin_date} to ${extractedData.checkout_date}</p>
                    <p><a href="${invoiceUrl}" target="_blank" style="color: #4299e1; font-weight: bold;">üîó View & Send Stripe Invoice</a></p>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Error Processing Invoice</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Tip:</strong> Check your API keys and screenshot quality</p>
                `;
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = 'üöÄ Create Stripe Invoice';
            }
        }

        async function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processWithClaude(base64Image, claudeKey) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': claudeKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-sonnet-20240229',
                    max_tokens: 1000,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image',
                                source: {
                                    type: 'base64',
                                    media_type: 'image/jpeg',
                                    data: base64Image
                                }
                            },
                            {
                                type: 'text',
                                text: `Extract booking information from this Booking.com screenshot and return ONLY valid JSON in this exact format (no markdown, no extra text):
                                {
                                    "customer_name": "Full Name",
                                    "customer_email": "email@domain.com",
                                    "amount": "1234.56",
                                    "currency": "MXN",
                                    "booking_reference": "123456789",
                                    "property_name": "Property Name",
                                    "checkin_date": "2025-12-29",
                                    "checkout_date": "2025-12-31"
                                }`
                            }
                        ]
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error(`Claude API Error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            const text = data.content[0].text.trim();
            
            // Clean up response to extract just JSON
            let jsonText = text;
            if (text.includes('```')) {
                jsonText = text.split('```')[1];
                if (jsonText.startsWith('json')) {
                    jsonText = jsonText.substring(4);
                }
            }
            
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                throw new Error(`Could not parse Claude response as JSON: ${text}`);
            }
        }

        async function createStripeInvoice(bookingData, stripeKey) {
            // Create customer first
            const customerResponse = await fetch('https://api.stripe.com/v1/customers', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${stripeKey}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    name: bookingData.customer_name,
                    email: bookingData.customer_email
                })
            });
            
            if (!customerResponse.ok) {
                throw new Error(`Stripe Customer Error: ${customerResponse.status}`);
            }
            
            const customer = await customerResponse.json();
            
            // Create invoice
            const invoiceResponse = await fetch('https://api.stripe.com/v1/invoices', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${stripeKey}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    customer: customer.id,
                    currency: bookingData.currency.toLowerCase(),
                    description: `Vacation Rental - Booking #${bookingData.booking_reference}`,
                    'metadata[booking_reference]': bookingData.booking_reference,
                    'metadata[property]': bookingData.property_name,
                    'metadata[checkin]': bookingData.checkin_date,
                    'metadata[checkout]': bookingData.checkout_date
                })
            });
            
            if (!invoiceResponse.ok) {
                throw new Error(`Stripe Invoice Error: ${invoiceResponse.status}`);
            }
            
            const invoice = await invoiceResponse.json();
            
            // Add line item
            const itemResponse = await fetch('https://api.stripe.com/v1/invoice_items', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${stripeKey}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    customer: customer.id,
                    invoice: invoice.id,
                    amount: Math.round(parseFloat(bookingData.amount) * 100), // Convert to cents
                    currency: bookingData.currency.toLowerCase(),
                    description: `${bookingData.property_name} (${bookingData.checkin_date} to ${bookingData.checkout_date})`
                })
            });
            
            if (!itemResponse.ok) {
                throw new Error(`Stripe Invoice Item Error: ${itemResponse.status}`);
            }
            
            // Finalize invoice
            const finalizeResponse = await fetch(`https://api.stripe.com/v1/invoices/${invoice.id}/finalize`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${stripeKey}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            
            if (!finalizeResponse.ok) {
                throw new Error(`Stripe Finalize Error: ${finalizeResponse.status}`);
            }
            
            const finalizedInvoice = await finalizeResponse.json();
            return finalizedInvoice.hosted_invoice_url;
        }

        // File upload drag and drop
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('screenshot');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3182ce';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#4299e1';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4299e1';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
    </script>
</body>
</html>
